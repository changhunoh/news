# -*- coding: utf-8 -*-
"""news_app.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/121ZEpqKaPF_gld8fM-PiP7MRsM7-991o
"""

import streamlit as st
from serpapi import GoogleSearch
import google.generativeai as genai # Google Generative AI SDK ì„í¬íŠ¸
import json
import os

# --- API í‚¤ ë¡œë“œ ---
# Streamlit Community Cloudì—ì„œëŠ” 'Secrets' ì„¹ì…˜ì— í‚¤ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
# ë¡œì»¬ ê°œë°œ ì‹œì—ëŠ” .streamlit/secrets.toml íŒŒì¼ì— ì €ì¥í•©ë‹ˆë‹¤.
# ì˜ˆì‹œ:
# SERPAPI_API_KEY = "YOUR_SERPAPI_API_KEY"
# GOOGLE_API_KEY = "YOUR_GOOGLE_API_KEY"
# GOOGLE_GEMINI_MODEL_NAME = "gemini-1.5-flash-latest" # ì‚¬ìš©í•  Gemini ëª¨ë¸ ì´ë¦„

try:
    SERPAPI_API_KEY = st.secrets["SERPAPI_API_KEY"]
    GOOGLE_API_KEY = st.secrets["GOOGLE_API_KEY"]
    # Gemini ëª¨ë¸ ì´ë¦„ë„ secretsì— ë„£ì–´ ê´€ë¦¬í•˜ë©´ ìœ ì—°ì„±ì´ ë†’ì•„ì§‘ë‹ˆë‹¤.
    # gemini-1.5-flash-latest ë˜ëŠ” gemini-1.5-pro-latest ë“±ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    GOOGLE_GEMINI_MODEL_NAME = st.secrets.get("GOOGLE_GEMINI_MODEL_NAME", "gemini-1.5-flash-latest")

    genai.configure(api_key=GOOGLE_API_KEY)
except KeyError as e:
    st.error(f"âš ï¸ ì˜¤ë¥˜: API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. {e} í‚¤ë¥¼ Streamlit Secretsì— ì¶”ê°€í•´ì£¼ì„¸ìš”.")
    st.info("Streamlit Community Cloudì—ì„œëŠ” 'Settings -> Secrets'ì—ì„œ API í‚¤ë¥¼ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
    st.stop() # API í‚¤ê°€ ì—†ìœ¼ë©´ ì•± ì‹¤í–‰ ì¤‘ì§€

# --- SerpApi ë‰´ìŠ¤ ê²€ìƒ‰ í•¨ìˆ˜ (ì´ì „ê³¼ ë™ì¼) ---
@st.cache_data(ttl=3600) # 1ì‹œê°„ ë™ì•ˆ ìºì‹œ
def search_news_with_serpapi(query, num_results=5):
    try:
        params = {
            "api_key": SERPAPI_API_KEY,
            "engine": "google",
            "q": query,
            "tbm": "nws",  # ë‰´ìŠ¤ ê²€ìƒ‰
            "num": num_results,
            "hl": "ko", # í•œêµ­ì–´ ê²°ê³¼ ì„ í˜¸
            "gl": "kr" # í•œêµ­ ì§€ì—­ ì„ í˜¸
        }
        search = GoogleSearch(params)
        results = search.get_dict()
        news_results = []
        if "news_results" in results:
            for news in results["news_results"]:
                news_results.append({
                    "title": news.get("title"),
                    "link": news.get("link"),
                    "snippet": news.get("snippet"),
                    "source": news.get("source"),
                    "date": news.get("date")
                })
        return news_results
    except Exception as e:
        st.error(f"SerpApi ë‰´ìŠ¤ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
        return []

# --- LLMì„ í™œìš©í•œ ìš”ì•½ ë° í‚¤ì›Œë“œ ì¶”ì¶œ í•¨ìˆ˜ (Google Gemini ì˜ˆì‹œ) ---
def summarize_and_extract_keywords(text):
    if not text:
        return "ë‚´ìš© ì—†ìŒ", "ë‚´ìš© ì—†ìŒ"

    try:
        # Gemini ëª¨ë¸ ì´ˆê¸°í™”
        model = genai.GenerativeModel(model_name=GOOGLE_GEMINI_MODEL_NAME)

        # í”„ë¡¬í”„íŠ¸ êµ¬ì„±
        prompt = f"""ë‹¤ìŒ ë‰´ìŠ¤ ê¸°ì‚¬ë¥¼ ìš”ì•½í•˜ê³  ì‰¼í‘œë¡œ êµ¬ë¶„ëœ 5-7ê°œì˜ í‚¤ì›Œë“œë¥¼ ì¶”ì¶œí•´ì£¼ì„¸ìš”.
ì‘ë‹µì€ ë°˜ë“œì‹œ ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ í•´ì£¼ì„¸ìš”: 'ìš”ì•½: [ìš”ì•½ ë‚´ìš©]\ní‚¤ì›Œë“œ: [í‚¤ì›Œë“œ1, í‚¤ì›Œë“œ2, ...]'

ë‰´ìŠ¤ ê¸°ì‚¬:
{text}
"""

        # LLM í˜¸ì¶œ
        response = model.generate_content(
            prompt,
            generation_config=genai.types.GenerationConfig(
                temperature=0.7,
                max_output_tokens=500,
            )
        )

        # ì‘ë‹µì—ì„œ í…ìŠ¤íŠ¸ ì¶”ì¶œ (response.textëŠ” í•˜ë‚˜ì˜ ë¬¸ìì—´ì„ ë°˜í™˜)
        content = response.text

        # LLM ì‘ë‹µì—ì„œ ìš”ì•½ê³¼ í‚¤ì›Œë“œë¥¼ íŒŒì‹±
        summary = ""
        keywords = ""
        if "ìš”ì•½:" in content and "í‚¤ì›Œë“œ:" in content:
            parts = content.split("í‚¤ì›Œë“œ:")
            summary = parts[0].replace("ìš”ì•½:", "").strip()
            keywords = parts[1].strip()
        else: # ì˜ˆìƒê³¼ ë‹¤ë¥¸ í˜•ì‹ì˜ ì‘ë‹µì¸ ê²½ìš° ì „ì²´ë¥¼ ìš”ì•½ìœ¼ë¡œ ê°„ì£¼
            summary = content
            keywords = "í‚¤ì›Œë“œ ì¶”ì¶œ ì‹¤íŒ¨ (í˜•ì‹ ì˜¤ë¥˜)"

        return summary, keywords
    except Exception as e:
        st.error(f"Gemini LLM ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
        return "ìš”ì•½ ì‹¤íŒ¨", "í‚¤ì›Œë“œ ì¶”ì¶œ ì‹¤íŒ¨"

# --- Streamlit ì•± UI (ì´ì „ê³¼ ë™ì¼) ---
st.set_page_config(
    page_title="ğŸ“° AI ë‰´ìŠ¤ ë¸Œë¦¬í¼",
    layout="centered", # ëª¨ë°”ì¼ í™”ë©´ì— ê°€ê¹ê²Œ ì¤‘ì•™ ì •ë ¬
    initial_sidebar_state="collapsed", # ì´ˆê¸° ì‚¬ì´ë“œë°” ìˆ¨ê¹€
    menu_items={ # í–„ë²„ê±° ë©”ë‰´ ì»¤ìŠ¤í„°ë§ˆì´ì§•
        'About': "ì´ ì•±ì€ SerpApiì™€ Google Geminië¥¼ í™œìš©í•˜ì—¬ ë‰´ìŠ¤ ê¸°ì‚¬ë¥¼ ê²€ìƒ‰í•˜ê³  ìš”ì•½í•©ë‹ˆë‹¤."
    }
)

# ëª¨ë°”ì¼ í™”ë©´ì²˜ëŸ¼ ë³´ì´ë„ë¡ CSS ì¶”ê°€ (ê¸°ë³¸ì ì¸ ë°˜ì‘í˜• ë””ìì¸)
st.markdown(
    """
    <style>
    /* ê¸°ë³¸ ì»¨í…Œì´ë„ˆ íŒ¨ë”© ì¡°ì • */
    .stApp > header {
        background-color: transparent;
    }
    .stApp {
        margin: auto;
        max-width: 700px; /* ëª¨ë°”ì¼ì²˜ëŸ¼ í­ ì œí•œ */
        padding-top: 1rem;
        padding-right: 1rem;
        padding-left: 1rem;
        padding-bottom: 1rem;
    }
    .main .block-container {
        padding-top: 1rem;
        padding-right: 1rem;
        padding-left: 1rem;
        padding-bottom: 1rem;
    }

    /* í…ìŠ¤íŠ¸ ì…ë ¥ì°½ ìŠ¤íƒ€ì¼ */
    .stTextInput>div>div>input {
        font-size: 1.1rem;
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
        border: 1px solid #ccc;
    }
    .stTextInput>label {
        font-size: 1rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }

    /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .stButton>button {
        font-size: 1.1rem;
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        width: 100%;
        margin-top: 1rem;
        background-color: #4CAF50; /* ë²„íŠ¼ ìƒ‰ìƒ */
        color: white;
        border: none;
        cursor: pointer;
    }
    .stButton>button:hover {
        background-color: #45a049;
    }

    /* ì œëª© ë° ë¶€ì œëª© ìŠ¤íƒ€ì¼ */
    h1 {
        color: #2e8b57; /* ì œëª© ìƒ‰ìƒ */
        text-align: center;
        margin-bottom: 0.5rem;
    }
    h3 {
        font-size: 1.3rem;
        margin-top: 1.5rem;
        margin-bottom: 0.5rem;
        color: #333;
    }

    /* Expander (ë‰´ìŠ¤ ê¸°ì‚¬) ìŠ¤íƒ€ì¼ */
    .stExpander details {
        background-color: #f0f2f6;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 0.75rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .stExpander details summary {
        font-weight: bold;
        font-size: 1.1rem;
        color: #2e8b57; /* ìš”ì•½ ì œëª© ìƒ‰ìƒ */
        cursor: pointer;
    }
    .stExpander div {
        padding-top: 0.5rem;
        padding-left: 0.5rem;
        padding-right: 0.5rem;
    }
    .stExpander div p {
        font-size: 0.95rem;
        line-height: 1.6;
        color: #555;
    }

    /* ë§í¬ ìŠ¤íƒ€ì¼ */
    a {
        color: #1a73e8;
        text-decoration: none;
        word-break: break-all; /* ê¸´ URLì´ ë„˜ì¹˜ì§€ ì•Šë„ë¡ */
    }
    a:hover {
        text-decoration: underline;
    }

    /* êµ¬ë¶„ì„  ìŠ¤íƒ€ì¼ */
    hr {
        border-top: 1px solid #eee;
        margin: 1.5rem 0;
    }
    </style>
    """,
    unsafe_allow_html=True
)

st.title("ğŸ“° AI ë‰´ìŠ¤ ë¸Œë¦¬í¼")
st.markdown("ê´€ì‹¬ ìˆëŠ” í‚¤ì›Œë“œë¡œ ìµœì‹  ë‰´ìŠ¤ ê¸°ì‚¬ë¥¼ ê²€ìƒ‰í•˜ê³ , LLMì´ ìš”ì•½ ë° í‚¤ì›Œë“œë¥¼ ì¶”ì¶œí•´ ë“œë¦½ë‹ˆë‹¤.")

search_query = st.text_input("ê²€ìƒ‰í•  ë‰´ìŠ¤ í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì¸ê³µì§€ëŠ¥, ì „ê¸°ì°¨, ê¸°í›„ ë³€í™”)", key="search_input")

if st.button("ë‰´ìŠ¤ ê²€ìƒ‰ ë° ìš”ì•½ ì‹œì‘"):
    if search_query:
        with st.spinner("â³ ë‰´ìŠ¤ ê¸°ì‚¬ ê²€ìƒ‰ ì¤‘... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”."):
            news_articles = search_news_with_serpapi(search_query)

        if news_articles:
            st.subheader(f"âœ¨ '{search_query}' ê´€ë ¨ ìµœì‹  ë‰´ìŠ¤ ê¸°ì‚¬")
            for i, article in enumerate(news_articles):
                with st.expander(f"**{i+1}. {article.get('title', 'ì œëª© ì—†ìŒ')}**"):
                    st.write(f"**ì¶œì²˜:** {article.get('source', 'ì•Œ ìˆ˜ ì—†ìŒ')} | **ë‚ ì§œ:** {article.get('date', 'ì•Œ ìˆ˜ ì—†ìŒ')}")
                    st.markdown(f"**ë§í¬:** [ë‰´ìŠ¤ ì›ë¬¸ ë°”ë¡œê°€ê¸°]({article.get('link', '#')})")
                    st.markdown(f"**_ì›ë¬¸ ë¯¸ë¦¬ë³´ê¸°:_**\n{article.get('snippet', 'ë¯¸ë¦¬ë³´ê¸°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. SerpApiì—ì„œ ìŠ¤ë‹ˆí«ì„ ì œê³µí•˜ì§€ ì•Šì•˜ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.')}")

                    if article.get('snippet'):
                        with st.spinner("ğŸ§  Gemini LLMìœ¼ë¡œ ìš”ì•½ ë° í‚¤ì›Œë“œ ì¶”ì¶œ ì¤‘..."):
                            summary, keywords = summarize_and_extract_keywords(article['snippet'])
                        st.markdown("---")
                        st.markdown(f"**ğŸ“ ìš”ì•½:**\n{summary}")
                        st.markdown(f"**ğŸ·ï¸ í‚¤ì›Œë“œ:** {keywords}")
                    else:
                        st.warning("ìš”ì•½í•  ë‚´ìš©ì´ ì—†ì–´ LLMì„ ì‹¤í–‰í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")
                st.markdown("---") # ê° ê¸°ì‚¬ ì‚¬ì´ì— êµ¬ë¶„ì„ 

        else:
            st.warning("ğŸ˜“ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ í‚¤ì›Œë“œë¡œ ì‹œë„í•´ ë³´ì„¸ìš”.")
    else:
        st.warning("ğŸ‘‰ ê²€ìƒ‰ í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.")

st.sidebar.header("ì•± ì •ë³´")
st.sidebar.info(
    "ì´ ì•±ì€ [SerpApi](https://serpapi.com/)ë¥¼ ì‚¬ìš©í•˜ì—¬ ë‰´ìŠ¤ ê¸°ì‚¬ë¥¼ ê²€ìƒ‰í•˜ê³ , "
    "[Google Gemini API](https://ai.google.dev/)ë¥¼ ì‚¬ìš©í•˜ì—¬ ê¸°ì‚¬ë¥¼ ìš”ì•½í•˜ê³  í‚¤ì›Œë“œë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤."
)
st.sidebar.markdown("Made with â¤ï¸ by Your Name") # ë‹¹ì‹ ì˜ ì´ë¦„ ë˜ëŠ” íŒ€ëª…
st.sidebar.markdown("[GitHub ì €ì¥ì†Œ (ì˜ˆì‹œ)](https://github.com/your-username/your-repo-name)") # í•„ìš” ì‹œ GitHub ë§í¬ ì¶”ê°€