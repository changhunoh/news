# app.py
import os, re
from typing import List, Dict, Any, Optional
from datetime import datetime
from zoneinfo import ZoneInfo
import streamlit as st

# =========================
# ÌéòÏù¥ÏßÄ ÏÑ§Ï†ï
# =========================
st.set_page_config(page_title="Ïö∞Î¶¨ Ïó∞Í∏àÏà†ÏÇ¨", page_icon="üì∞", layout="centered")

# =========================
# ENV from st.secrets ‚Üí os.environ
# =========================
def _prime_env_from_secrets():
    try:
        if hasattr(st, "secrets") and st.secrets:
            for k, v in st.secrets.items():
                os.environ.setdefault(k, str(v))
        else:
            st.warning("No secrets found in st.secrets. Ensure secrets are properly configured.")
    except FileNotFoundError:
        st.error("Secrets file not found. Please check your Streamlit configuration.")
    except Exception as e:
        st.error(f"Error loading secrets: {e}")

_prime_env_from_secrets()

# =========================
# Í∏∞Î≥∏ Ïú†Ìã∏
# =========================
TZ = ZoneInfo(os.getenv("APP_TZ", "Asia/Seoul"))

def format_timestamp(dt: datetime) -> str:
    return dt.astimezone(TZ).strftime("%YÎÖÑ %mÏõî %dÏùº %p %I:%M").replace("AM", "Ïò§Ï†Ñ").replace("PM", "Ïò§ÌõÑ")

def _escape_html(s: Optional[str]) -> str:
    return (s or "").replace("&", "&amp;").replace("<", "&lt;").replace(">", "&gt;")

def _linkify(s: str) -> str:
    return re.sub(r"(https?://[\w\-\./%#\?=&:+,~]+)", r'<a href="\1" target="_blank">\1</a>', s or "")

def _build_messages_html(messages: List[Dict[str, Any]]) -> str:
    parts = []
    for i, m in enumerate(messages):
        role = m.get("role", "assistant")
        row  = "user-row" if role == "user" else "bot-row"
        bub  = "user-bubble" if role == "user" else "bot-bubble"
        text_raw = m.get("content", "") or ""
        ts   = _escape_html(m.get("ts", ""))

        # ÏÉùÏÑ± Ï§ë(typing) ÎßêÌíçÏÑ†
        if m.get("pending"):
            bubble = (
                '<div class="typing-bubble">'
                '<span class="typing-dot"></span>'
                '<span class="typing-dot"></span>'
                '<span class="typing-dot"></span>'
                '</div>'
            )
            parts.append(
                f'<div class="chat-row bot-row">{bubble}</div>'
                f'<div class="timestamp ts-left">{ts}</div>'
            )
            continue

        # ÏùºÎ∞ò Î≤ÑÎ∏î
        text = _linkify(_escape_html(text_raw))
        parts.append(
            f'<div class="chat-row {row}"><div class="chat-bubble {bub}">{text}</div></div>'
            f'<div class="timestamp {"ts-right" if role=="user" else "ts-left"}">{ts}</div>'
        )

        # ÏÜåÏä§Ïπ© (assistantÏóêÎßå)
        if role == "assistant":
            srcs = m.get("sources") or []
            if srcs:
                chips = []
                for j, d in enumerate(srcs, 1):
                    md = (d.get("metadata") or {}) if isinstance(d, dict) else {}
                    title = md.get("title") or md.get("path") or md.get("source") or f"Î¨∏ÏÑú {j}"
                    url = md.get("url")
                    try:
                        score = float(d.get("score", 0.0) or 0.0)
                    except Exception:
                        score = 0.0
                    label = f"#{j} {title} ¬∑ {score:.3f}"
                    link_html = f'<a href="{url}" target="_blank">{label}</a>' if url else label
                    chips.append(f'<span class="source-chip">{link_html}</span>')
                parts.append(f'<div class="src-row">{"".join(chips)}</div>')

    # Î≥∏Î¨∏ + Ïä§ÌÅ¨Î°§ ÏïµÏª§/Ïä§ÌéòÏù¥ÏÑú
    return (
        '<div class="screen-shell">'
        '<div class="screen-body" id="screen-body">'
        + "".join(parts) +
        '<div class="screen-spacer"></div>'
        '<div id="end-anchor"></div>'
        '</div></div>'
        '<script>(function(){'
        ' document.addEventListener("click", function(ev){'
        '   var b = ev.target.closest(".copy-btn"); if(!b) return;'
        '   var txt = b.getAttribute("data-text") || "";'
        '   var ta = document.createElement("textarea"); ta.value = txt;'
        '   document.body.appendChild(ta); ta.select(); try{document.execCommand("copy");}catch(e){};'
        '   document.body.removeChild(ta);'
        ' }, true);'
        ' try {'
        '   var end = document.getElementById("end-anchor");'
        '   if (end) end.scrollIntoView({behavior:"instant", block:"end"});'
        ' } catch(e){}'
        '})();</script>'
    )

# =========================
# CSS
# =========================
st.markdown("""
<style>
:root{
  color-scheme: light !important;
  --brand:#0b62e6; --bezel:#0b0e17; --screen:#ffffff;
  --line:#e6ebf4; --chip:#eef4ff; --text:#1f2a44;
  --dock-h: 140px; /* ÏûÖÎ†• Dock Ï†ÑÏ≤¥ ÎÜíÏù¥(Í∑∏Î¶ºÏûê Ìè¨Ìï®) */
}
html, body, [data-testid="stAppViewContainer"]{ height: 100%; }
html, body, [data-testid="stAppViewContainer"], section.main, .stMain, [data-testid="stSidebar"]{
  background: radial-gradient(1200px 700px at 50% 0, #f0f4ff 0%, #f6f8fb 45%, #eef1f6 100%) !important;
  color: var(--text) !important;
}
.block-container > :first-child{
  position: relative !important;
  height: clamp(620px, 82vh, 860px);
  background: var(--screen) !important;
  border: 1px solid var(--line) !important;
  border-radius: 30px !important;
  padding: 12px 14px 14px !important;
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.65);
  overflow: hidden;
  display: flex;
  flex-direction: column;
}
.block-container > :first-child > div{
  display: flex; flex-direction: column; flex: 1 1 auto; min-height: 0;
}
.screen-shell{ position: relative; display:flex; flex-direction:column; flex:1 1 auto; min-height:0; }
.block-container > :first-child .element-container:has(.screen-shell){ height: 100%; }
.screen-body{
  flex: 1 1 auto; min-height: 0; overflow-y: auto; touch-action: pan-y; -webkit-overflow-scrolling: touch;
  padding: 8px 10px 12px; scrollbar-width: thin; scrollbar-color: #c0c7d6 #f0f4ff;
}
.screen-body::-webkit-scrollbar{ width:8px; }
.screen-body::-webkit-scrollbar-track{ background:#f0f4ff; border-radius:8px; }
.screen-body::-webkit-scrollbar-thumb{ background:#c0c7d6; border-radius:8px; }
.screen-body::-webkit-scrollbar-thumb:hover{ background:#a0a7b6; }
.screen-body{ overscroll-behavior: contain; }
.screen-spacer{ flex: 0 0 var(--dock-h); height: var(--dock-h); }
.stChatInputContainer{ display:none !important; }
a{ color: var(--brand) !important; }
hr{ border:0; border-top:1px solid var(--line) !important; }
button, .stButton > button, .stDownloadButton > button{
  background: var(--chip) !important; border:1px solid #dce7ff !important; color:var(--brand) !important;
  border-radius:999px !important; font-weight:700 !important; padding:8px 14px !important;
  min-height:auto !important; line-height:1.1 !important;
}
.st-expander, .st-expander div[role="button"]{
  background:#fff !important; border:1px solid var(--line) !important; color:var(--text) !important;
}
.chat-header{ display:flex; align-items:center; justify-content:space-between; margin:8px 6px 12px; }
.chat-title{ font-size:20px; font-weight:900; color:var(--text); letter-spacing:.2px; }
.reset-btn > button{
  width:38px; height:38px; border-radius:999px !important;
  background:var(--chip) !important; color:var(--brand) !important;
  border:1px solid #dce7ff !important; box-shadow:0 4px 12px rgba(23,87,255,.08);
}
.chat-row{ display:flex; margin:12px 0; align-items:flex-end; }
.user-row{ justify-content:flex-end; }
.bot-row{ justify-content:flex-start; align-items:flex-start !important; }
.chat-bubble{
  max-width:86%; padding:14px 16px; border-radius:18px; line-height:1.65; font-size:16px;
  background:#ffffff; color:var(--text); border:1px solid var(--line); border-bottom-left-radius:8px;
  box-shadow:0 10px 22px rgba(15,23,42,.08); white-space:pre-wrap; overflow-wrap:anywhere; word-break:break-word;
}
.bot-row .chat-bubble{ position:relative; margin-left:54px; margin-top:2px; }
.bot-row .chat-bubble::before{
  content:"üßô‚Äç‚ôÇÔ∏è"; position:absolute; left:-54px; top:0; width:42px; height:42px; border-radius:999px;
  background:#fff; border:1px solid var(--line); display:flex; align-items:center; justify-content:center; font-size:20px;
  box-shadow:0 6px 14px rgba(15,23,42,.08);
}
.user-bubble{
  background:var(--brand) !important; color:#fff !important; border:0 !important;
  border-bottom-right-radius:8px; box-shadow:0 10px 28px rgba(11,98,230,.26);
  font-weight:700; letter-spacing:.2px; padding:16px 18px;
}
.timestamp{ font-size:12px; color:#6b7280; margin:4px 6px; }
.ts-left{ text-align:left; } .ts-right{ text-align:right; }
.action-bar{ display:flex; gap:8px; margin:6px 6px 0; }
.action-btn{ font-size:12px; padding:6px 10px; border-radius:10px; border:1px solid #dce7ff; background:#eef4ff; color:var(--brand); }
.source-chip{
  display:inline-block; padding:4px 10px; border-radius:999px; background:#eef4ff; color:var(--brand);
  font-weight:800; font-size:12px; border:1px solid #dce7ff; margin:6px 6px 0 0;
}
.source-chip a{ color:var(--brand); text-decoration:none; }
.source-chip a:hover{ text-decoration:underline; }
.chat-dock{
  position:absolute !important; left:50% !important; bottom:16px !important; transform:translateX(-50%);
  width:92%; max-width:370px; z-index:30; filter: drop-shadow(0 10px 20px rgba(15,23,42,.18));
}
.chat-dock .dock-wrap{
  display:flex; gap:8px; align-items:center; background:#fff; border-radius:999px; padding:8px;
  border:1px solid #e6ebf4; box-shadow:0 8px 24px rgba(15,23,42,.10);
}
.chat-dock .stTextInput > div > div{ background:transparent !important; border:0 !important; padding:0 !important; }
.chat-dock input{ height:44px !important; padding:0 12px !important; font-size:15px !important; background:#ffffff !important; color:#1f2a44 !important; }
.chat-dock .send-btn > button{
  width:40px; height:40px; border-radius:999px !important; background:#e6efff !important; color:#0b62e6 !important;
  border:0 !important; box-shadow:inset 0 0 0 1px #d8e6ff; font-weight:800;
}
@media (max-width: 480px){
  .block-container > :first-child{ height: clamp(560px, 86vh, 820px); }
  .block-container{ max-width: 94vw; }
}
[data-testid="stHeader"]{ background:transparent !important; border:0 !important; }
.chat-dock:empty, .chat-dock .dock-wrap:empty{ display:none !important; }
.chat-dock .dock-wrap > *:not(form){ display:none !important; }
.typing-bubble{
  max-width:86%; padding:14px 16px; border-radius:18px; background:#ffffff; color:var(--text);
  border:1px solid var(--line); border-bottom-left-radius:8px; box-shadow:0 10px 22px rgba(15,23,42,.08);
  display:inline-flex; gap:6px; align-items:center;
}
.typing-dot{
  width:8px; height:8px; border-radius:50%; background:#a8b3c8; display:inline-block;
  animation: typingDot 1.2s infinite ease-in-out;
}
.typing-dot:nth-child(2){ animation-delay: .15s; }
.typing-dot:nth-child(3){ animation-delay: .3s; }
@keyframes typingDot{
  0%, 80%, 100% { transform: translateY(0); opacity:.5; }
  40% { transform: translateY(-4px); opacity:1; }
}
</style>
""", unsafe_allow_html=True)

# =========================
# JS: ÎÜíÏù¥ Î≥¥Ï†ï
# =========================
st.markdown("""
<script>
(function(){
  function fit(){
    const card = document.querySelector('.block-container > :first-child');
    const body = document.getElementById('screen-body') || document.querySelector('.screen-body');
    const dock = document.querySelector('.chat-dock');
    if(!card || !body) return;
    const cardRect = card.getBoundingClientRect();
    const bodyRect = body.getBoundingClientRect();
    const topInside = bodyRect.top - cardRect.top;
    const dockH = (dock ? dock.offsetHeight : 0) + 16; // ÏïÑÎûò Ïó¨Ïú†
    const targetH = card.clientHeight - topInside - dockH;
    if (targetH > 120) {
      body.style.height = targetH + 'px';
      body.style.overflowY = 'auto';
    }
  }
  window.addEventListener('load', fit);
  window.addEventListener('resize', fit);
  const ro = new ResizeObserver(fit);
  ro.observe(document.body);
  setTimeout(fit, 50); setTimeout(fit, 200); setTimeout(fit, 600);
})();
</script>
""", unsafe_allow_html=True)

# =========================
# Î∞±ÏóîÎìú ÏÑúÎπÑÏä§ (ÏÑ†ÌÉù)
# =========================
try:
    from news_qna_service import NewsQnAService
except Exception as e:
    NewsQnAService = None
    st.error(f"[ÏûÑÌè¨Ìä∏ Ïò§Î•ò] news_qna_service Î™®ÎìàÏùÑ Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§: {e}")

@st.cache_resource
def get_service():
    if NewsQnAService is None:
        return None
    try:
        return NewsQnAService(
            project=os.getenv("GOOGLE_CLOUD_PROJECT"),
            location=os.getenv("GOOGLE_CLOUD_LOCATION", "us-central1"),
            qdrant_url=os.getenv("QDRANT_URL"),
            qdrant_key=os.getenv("QDRANT_API_KEY"),
            collection=os.getenv("COLLECTION_NAME", "stock_news"),
            embed_model_name=os.getenv("EMBED_MODEL_NAME", "gemini-embedding-001"),
            gen_model_name=os.getenv("GENAI_MODEL_NAME", "gemini-2.5-pro"),
            embed_dim=int(os.getenv("EMBED_DIM", "3072")),
            top_k=int(os.getenv("DEFAULT_TOP_K", "5")),
            use_rerank=False,
        )
    except Exception as e:
        st.error(f"NewsQnAService Ï¥àÍ∏∞Ìôî Ïã§Ìå®: {e}")
        return None

svc = get_service()

# =========================
# Vertex AI (ÏÉùÏÑ±Î™®Îç∏Îßå)
# =========================
_vertex_inited = False
_gen_model = None

def _ensure_vertex_init() -> bool:
    global _vertex_inited
    if _vertex_inited:
        return True
    try:
        project = os.getenv("GOOGLE_CLOUD_PROJECT")
        location = os.getenv("GOOGLE_CLOUD_LOCATION", "us-central1")
        if not project:
            st.error("GOOGLE_CLOUD_PROJECT is not set in environment variables.")
            return False
        import vertexai
        vertexai.init(project=project, location=location)
        _vertex_inited = True
        return True
    except Exception as e:
        st.error(f"Failed to initialize Vertex AI: {e}")
        return False

def _get_gen_model():
    global _gen_model
    if _gen_model is None:
        if not _ensure_vertex_init():
            return None
        try:
            from vertexai.generative_models import GenerativeModel
            _gen_model = GenerativeModel(os.getenv("GENAI_MODEL_NAME", "gemini-2.5-pro"))
        except Exception as e:
            st.error(f"ÏÉùÏÑ± Î™®Îç∏ Î°úÎî© Ïã§Ìå®: {e}")
            return None
    return _gen_model

def generate_with_context(question: str, main_sources: List[Dict[str, Any]]) -> str:
    def snip(t, n=1800): 
        return re.sub(r"\s+", " ", t or "")[:n]
    ctx = "\n\n".join([snip(d.get("content", "")) for d in main_sources])[:10000]
    sys = (
        "ÎãπÏã†ÏùÄ Ï£ºÏãù/Ïó∞Í∏à Îâ¥Ïä§Î•º Î∞îÌÉïÏúºÎ°ú ÎãµÌïòÎäî Î∂ÑÏÑùÍ∞ÄÏûÖÎãàÎã§. "
        "Ïª®ÌÖçÏä§Ìä∏ Í∑ºÍ±∞Î°ú ÌïúÍµ≠Ïñ¥Î°ú Ï†ïÌôïÌïòÍ≤å ÎãµÌïòÏÑ∏Ïöî. "
        "Í∑ºÍ±∞Í∞Ä Î∂ÄÏ°±ÌïòÎ©¥ Ï∂îÏ†ïÌïòÏßÄ ÎßêÍ≥† 'Í¥ÄÎ†®Îêú Ï†ïÎ≥¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.'ÎùºÍ≥† ÎãµÌïòÏÑ∏Ïöî. "
        "ÌïµÏã¨ÏùÄ **ÍµµÍ≤å** Í∞ïÏ°∞ÌïòÏÑ∏Ïöî."
    )
    prompt = f"{sys}\n\n[Ïª®ÌÖçÏä§Ìä∏]\n{ctx}\n\n[ÏßàÎ¨∏]\n{question}"

    model = _get_gen_model()
    if model is None:
        return "ÏÉùÏÑ± Î™®Îç∏ Ï¥àÍ∏∞ÌôîÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. ÌôòÍ≤Ω Î≥ÄÏàòÏôÄ Vertex ÏÑ§Ï†ïÏùÑ ÌôïÏù∏Ìï¥ Ï£ºÏÑ∏Ïöî."
    try:
        from vertexai.generative_models import GenerationConfig
        resp = model.generate_content(
            prompt,
            generation_config=GenerationConfig(temperature=0.2)
        )
        return (getattr(resp, "text", None) or "").strip() or "Í¥ÄÎ†®Îêú Ï†ïÎ≥¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§."
    except Exception as e:
        return f"ÎãµÎ≥Ä ÏÉùÏÑ± Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: {e}"

# =========================
# ÏÑ∏ÏÖò ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
# =========================
if "messages" not in st.session_state:
    st.session_state["messages"] = [{
        "role": "assistant",
        "content": "ÏïàÎÖïÌïòÏÑ∏Ïöî! ‚úÖ Ïó∞Í∏à/Ï£ºÏãù Îâ¥Ïä§Î•º Í∑ºÍ±∞Î°ú QnA ÎèÑÏôÄÎìúÎ†§Ïöî. Î¨¥ÏóáÏù¥Îì† Î¨ºÏñ¥Î≥¥ÏÑ∏Ïöî.",
        "sources": [],
        "ts": format_timestamp(datetime.now(TZ))
    }]

if "_preset" not in st.session_state:
    st.session_state["_preset"] = None

# =========================
# Ìó§Îçî/ÌîÑÎ¶¨ÏÖã
# =========================
head_l, head_r = st.columns([1.5, 0.16])
with head_l:
    st.markdown('<div class="chat-header"><div class="chat-title">üßô‚Äç‚ôÇÔ∏è Ïö∞Î¶¨ Ïó∞Í∏àÏà†ÏÇ¨</div></div>', unsafe_allow_html=True)
with head_r:
    if st.button("üîÑ", help="ÎåÄÌôî Ï¥àÍ∏∞Ìôî", use_container_width=True):
        st.session_state["messages"] = [{
            "role": "assistant",
            "content": "ÎåÄÌôîÎ•º ÏÉàÎ°ú ÏãúÏûëÌï©ÎãàÎã§. Î¨¥ÏóáÏù¥ Í∂ÅÍ∏àÌïòÏã†Í∞ÄÏöî?",
            "sources": [],
            "ts": format_timestamp(datetime.now(TZ))
        }]
        st.session_state["_preset"] = None
        st.rerun()

cols = st.columns(3)
for i, label in enumerate(["Ïö∞Î¶¨Í∏àÏúµÏßÄÏ£º Ï†ÑÎßù?", "Ìò∏ÌÖîÏã†Îùº Ïã§Ï†Å Ìè¨Ïù∏Ìä∏?", "Î∞∞ÎãπÏ£º Ìè¨Ìä∏ Ï†úÏïà"]):
    with cols[i]:
        if st.button(label, use_container_width=True):
            st.session_state["_preset"] = label

st.divider()

# =========================
# Î©îÏãúÏßÄ ÏòÅÏó≠ + placeholder
# =========================
ph_messages = st.empty()
ph_messages.markdown(_build_messages_html(st.session_state["messages"]), unsafe_allow_html=True)

# =========================
# ÏûÖÎ†• Dock (Ìèº)
# =========================
st.markdown('<div class="chat-dock"><div class="dock-wrap">', unsafe_allow_html=True)
with st.form("chat_form", clear_on_submit=True):
    c1, c2 = st.columns([1, 0.18])
    user_q = c1.text_input("ÏßàÎ¨∏ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî...", key="custom_input", label_visibility="collapsed")
    submitted = c2.form_submit_button("‚û§", use_container_width=True, type="primary")
st.markdown('</div></div>', unsafe_allow_html=True)

# =========================
# Ï†úÏ∂ú Ï≤òÎ¶¨ Î°úÏßÅ
# =========================
def run_answer(question: str):
    # ÏÇ¨Ïö©Ïûê Î©îÏãúÏßÄ Ï∂îÍ∞Ä
    now = format_timestamp(datetime.now(TZ))
    st.session_state["messages"].append({"role": "user", "content": question, "sources": [], "ts": now})

    # pending Î≤ÑÎ∏î + Ï¶âÏãú Î†åÎçî
    now_p = format_timestamp(datetime.now(TZ))
    st.session_state["messages"].append({"role": "assistant", "content": "", "sources": [], "ts": now_p, "pending": True})
    ph_messages.markdown(_build_messages_html(st.session_state["messages"]), unsafe_allow_html=True)

    # ÏÉùÏÑ±
    with st.spinner("Í≤ÄÏÉâ/ÏÉùÏÑ± Ï§ë‚Ä¶"):
        main: Dict[str, Any] = {}
        if svc is None:
            st.warning("Î∞±ÏóîÎìú ÏÑúÎπÑÏä§Í∞Ä Ï¥àÍ∏∞ÌôîÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§. news_qna_service Î™®Îìà/ÌôòÍ≤ΩÎ≥ÄÏàòÎ•º ÌôïÏù∏Ìï¥ Ï£ºÏÑ∏Ïöî.")
        else:
            try:
                main = svc.answer(question) or {}
            except Exception as e:
                st.error(f"svc.answer Ïò§Î•ò: {e}")
                main = {}

        main_sources = main.get("source_documents", []) or []
        answer = generate_with_context(question, main_sources)

    # pending ÍµêÏ≤¥
    st.session_state["messages"][-1] = {
        "role": "assistant",
        "content": answer,
        "sources": main_sources,
        "ts": format_timestamp(datetime.now(TZ))
    }
    ph_messages.markdown(_build_messages_html(st.session_state["messages"]), unsafe_allow_html=True)

# =========================
# Ïã§Ìñâ Ìä∏Î¶¨Í±∞
# =========================
if submitted and user_q:
    run_answer(user_q)
elif st.session_state.get("_preset"):
    run_answer(st.session_state["_preset"])
    st.session_state["_preset"] = None
