# app.py
import os
from typing import List, Dict, Any, Optional
import streamlit as st

from news_report_service import NewsReportService

st.set_page_config(page_title="ì—°ê¸ˆìˆ ì‚¬ì˜ ë¹„ë°€ì„œì¬ğŸ“˜", page_icon="ğŸ“°", layout="centered")

SAMPLE_FINAL_REPORT =  """
### ê¸ˆìœµ ì„¹í„° ì£¼ìš” ì¢…ëª© ì¢…í•© ë¶„ì„ ë¦¬í¬íŠ¸

#### 1. ì¢…ëª©ë³„ í•µì‹¬ ë‰´ìŠ¤ì™€ ê°€ê²© ì˜í–¥ ê²½ë¡œ ë¹„êµ

ğŸ“Œ **ìš°ë¦¬ê¸ˆìœµì§€ì£¼: ë¹„í•µì‹¬ìì‚° ë§¤ê°ì„ í†µí•œ ìë³¸ì ì •ì„± ê°•í™”**
*   **í•µì‹¬ ë‰´ìŠ¤**: ê²½ê¸°ë„ ì•ˆì„± ì—°ìˆ˜ì› ë§¤ê° ì¶”ì§„. ìµœì†Œ ë§¤ê° í¬ë§ê°€ `400ì–µì›`. ì´ëŠ” ì•½ `2ì¡°ì›` ê·œëª¨ì˜ ì „ì²´ ìœ íœ´ ë¶€ë™ì‚° ë§¤ê° ê³„íšì˜ ì¼í™˜.
*   **ê°€ê²© ì˜í–¥ ê²½ë¡œ**:
    *   ğŸ“ˆ **ê¸ì •ì  (ì¤‘ê¸°)**: ìœ í˜•ìì‚° ë§¤ê° ì´ìµì€ **ìë³¸ë¹„ìœ¨(CET1)ì„ ì§ì ‘ì ìœ¼ë¡œ ê°œì„ **í•˜ëŠ” íš¨ê³¼. ì¬ë¬´ ê±´ì „ì„± ê°•í™”ëŠ” í–¥í›„ M&A ë“± ì„±ì¥ ë™ë ¥ í™•ë³´ë¥¼ ìœ„í•œ ì‹¤íƒ„ìœ¼ë¡œ í™œìš© ê°€ëŠ¥. ê¸ˆìœµë‹¹êµ­ì˜ ì¡°ê±´ë¶€ ìŠ¹ì¸ ì‚¬í•­ ì´í–‰ì´ë¼ëŠ” ì ë„ ë¶ˆí™•ì‹¤ì„± í•´ì†Œ ìš”ì¸.

ğŸ“Œ **ì‚¼ì„±í™”ì¬: ë””ì§€í„¸ ì±„ë„ ê¸°ë°˜ ì—¬í–‰ë³´í—˜ì˜ í­ë°œì  ì„±ì¥**
*   **í•µì‹¬ ë‰´ìŠ¤**: í•´ì™¸ì—¬í–‰ë³´í—˜ ê°€ì…ì ë° ì›ìˆ˜ë³´í—˜ë£Œ ê¸‰ì¦(ì „ì›” ëŒ€ë¹„ ê° `37.6%`, `37.1%` ì¦ê°€). ë””ì§€í„¸ í”Œë«í¼ì„ í†µí•œ ì Šì€ ì¸µ(`2030` ë¹„ì¤‘ `52.6%`) ìœ ì… ì„±ê³µ.
*   **ê°€ê²© ì˜í–¥ ê²½ë¡œ**:
    *   ğŸ“ˆ **ê¸ì •ì  (ë‹¨ê¸°/ì¤‘ê¸°)**: ë¦¬ì˜¤í”„ë‹ì— ë”°ë¥¸ **ê²¬ì¡°í•œ ì‹¤ì  ì„±ì¥ì„¸**ë¥¼ ì§ì ‘ì ìœ¼ë¡œ ì¦ëª…. íŠ¹íˆ, ë””ì§€í„¸ ì±„ë„ ê²½ìŸë ¥ê³¼ ìƒí’ˆ í˜ì‹ (ì—°ê°„ ë³´í—˜, ì„ ë¬¼í•˜ê¸° ë“±)ì€ ì§€ì† ê°€ëŠ¥í•œ ì„±ì¥ ëª¨ë¸ì„ ì œì‹œí•˜ë©° **ìˆ˜ìµì„± ë° ì‹œì¥ ì§€ë°°ë ¥ ê°•í™”**ì— ê¸°ì—¬.

ğŸ“Œ **ì‚¼ì„±ìƒëª…: ëšœë ·í•œ ëª¨ë©˜í…€ ë¶€ì¬ ì† ìƒëŒ€ì  ê°•ì„¸**
*   **í•µì‹¬ ë‰´ìŠ¤**: ì‹œì¥ ë³´í•©ì„¸ ì†ì—ì„œ `2.33%` ìƒìŠ¹í•˜ë©° ìƒëŒ€ì  ê°•ì„¸ ì‹œí˜„. ì™¸êµ­ì¸ íˆ¬ìì ë™í–¥ì´ ì£¼ìš” ë³€ìˆ˜ë¡œ ì‘ìš©.
*   **ê°€ê²© ì˜í–¥ ê²½ë¡œ**:
    *   ğŸ“ˆ **ê¸ì •ì  (ë‹¨ê¸°)**: ëšœë ·í•œ ê°œë³„ í˜¸ì¬ ì—†ì´ ì‹œì¥ ëŒ€ë¹„ ê°•í•œ ìˆ˜ê¸‰ì´ ìœ ì…ë˜ê³  ìˆë‹¤ëŠ” ì ì€ ê¸ì •ì .
    *   âš ï¸ **ì¤‘ë¦½ì  (ì¤‘ê¸°)**: ë‹¤ë§Œ, **í€ë”ë©˜í„¸ ê°œì„ ì„ ë™ë°˜í•œ ìƒìŠ¹ì´ ì•„ë‹ˆë¯€ë¡œ** ì¶”ì„¸ ì§€ì† ì—¬ë¶€ëŠ” ë¶ˆí™•ì‹¤. ê¸ˆë¦¬ ë“± ê±°ì‹œ ë³€ìˆ˜ì™€ ì™¸êµ­ì¸ ìˆ˜ê¸‰ì— ë”°ë¼ ë³€ë™ì„± í™•ëŒ€ ê°€ëŠ¥.

ğŸ“Œ **ì¹´ì¹´ì˜¤ë±…í¬: ìŠ¤í†¡ì˜µì…˜ í–‰ì‚¬ì— ë”°ë¥¸ ì˜¤ë²„í–‰(Overhang) ìš°ë ¤**
*   **í•µì‹¬ ë‰´ìŠ¤**: ì£¼ì‹ë§¤ìˆ˜ì„ íƒê¶Œ(ìŠ¤í†¡ì˜µì…˜) í–‰ì‚¬ì— ë”°ë¥¸ ë³´í†µì£¼ ì¶”ê°€ ìƒì¥.
*   **ê°€ê²© ì˜í–¥ ê²½ë¡œ**:
    *   âš ï¸ **ë¶€ì •ì  (ë‹¨ê¸°)**: ì‹ ê·œ ì£¼ì‹ ìœ í†µì— ë”°ë¥¸ **ê³µê¸‰ ë¬¼ëŸ‰ ë¶€ë‹´(ì˜¤ë²„í–‰)**ì€ ê¸°ì¡´ ì£¼ì£¼ ì§€ë¶„ê°€ì¹˜ í¬ì„ ìš°ë ¤ë¥¼ ë‚³ìœ¼ë©° ì£¼ê°€ì— ë‹¨ê¸° í•˜ë°© ì••ë ¥ìœ¼ë¡œ ì‘ìš©. ì„ì§ì› ë³´ìƒì´ë¼ëŠ” ì¥ê¸°ì  ê¸ì • íš¨ê³¼ë³´ë‹¤ ë‹¨ê¸°ì  ìˆ˜ê¸‰ ë¶€ë‹´ì´ ë” í¬ê²Œ ë¶€ê°ë  ê°€ëŠ¥ì„±.

ğŸ“Œ **ë©”ë¦¬ì¸ ê¸ˆìœµì§€ì£¼: ì£¼ì£¼í™˜ì› ì •ì±…ì˜ í•µì‹¬, ê°ì•¡ë°°ë‹¹ì— ëŒ€í•œ ê³¼ì„¸**
*   **í•µì‹¬ ë‰´ìŠ¤**: ì •ë¶€ì˜ ê°ì•¡ë°°ë‹¹(ìë³¸ì¤€ë¹„ê¸ˆ í™œìš© ë°°ë‹¹)ì— ëŒ€í•œ ëŒ€ì£¼ì£¼ ë°°ë‹¹ì†Œë“ì„¸ ê³¼ì„¸ ë°©ì¹¨ ë°œí‘œ.
*   **ê°€ê²© ì˜í–¥ ê²½ë¡œ**:
    *   âš ï¸ **ë¶€ì •ì  (ì¤‘ê¸°)**: ë©”ë¦¬ì¸ ê¸ˆìœµì˜ **í•µì‹¬ íˆ¬ì í¬ì¸íŠ¸ì˜€ë˜ ê³ ë°°ë‹¹ ë° ì£¼ì£¼í™˜ì› ì •ì±…ì˜ ë§¤ë ¥ë„ ì €í•˜** ìš°ë ¤. ê³¼ê±°ì™€ ê°™ì€ íŒŒê²©ì ì¸ ê°ì•¡ë°°ë‹¹ì´ ì–´ë ¤ì›Œì§ˆ ê²½ìš°, ë°°ë‹¹ ì •ì±…ì˜ ë³€í™”ê°€ ë¶ˆê°€í”¼í•˜ë©° ì´ëŠ” ê¸°ì—…ê°€ì¹˜ í‰ê°€ì— ë¶€ì •ì  ì˜í–¥ì„ ë¯¸ì¹  ìˆ˜ ìˆìŒ.

#### 2. ê³µí†µ í…Œë§ˆ ì‹ë³„ ë° êµì°¨ì˜í–¥ ì„¤ëª…

ğŸ“Œ **ê·œì œ ë° ì„¸ì œ ë³€í™”ì˜ ì§ì ‘ì  ì˜í–¥**
*   ê¸ˆìœµ ì‚°ì—…ì€ ë³¸ì§ˆì ìœ¼ë¡œ ê·œì œ ì‚°ì—…ì„ì„ ì¬í™•ì¸. **ë©”ë¦¬ì¸ ê¸ˆìœµì§€ì£¼**ëŠ” ê°ì•¡ë°°ë‹¹ ê³¼ì„¸ë¼ëŠ” ì„¸ì œ ë³€í™”ì— ì§ì ‘ì ì¸ íƒ€ê²©ì„ ì…ìœ¼ë©°, ì´ëŠ” íšŒì‚¬ì˜ í•µì‹¬ ì „ëµ ìˆ˜ì •ìœ¼ë¡œ ì´ì–´ì§ˆ ìˆ˜ ìˆëŠ” ì¤‘ëŒ€í•œ ë³€ìˆ˜. **ìš°ë¦¬ê¸ˆìœµì§€ì£¼** ì—­ì‹œ ê¸ˆìœµë‹¹êµ­ì˜ ì¡°ê±´ë¶€ ìŠ¹ì¸(ìœ íœ´ ë¶€ë™ì‚° ë§¤ê°)ì„ ì´í–‰í•˜ëŠ” ê³¼ì •ì—ì„œ ìì‚° ë§¤ê°ì´ ì§„í–‰ë˜ëŠ” ë“± ê·œì œ í™˜ê²½ì´ ê²½ì˜ ì „ëµì— ë¯¸ì¹˜ëŠ” ì˜í–¥ì´ ì§€ëŒ€í•¨. **ì¹´ì¹´ì˜¤ë±…í¬** ë˜í•œ ì ì¬ì ì¸ í”Œë«í¼ ê·œì œ ë¦¬ìŠ¤í¬ì— ìƒì‹œ ë…¸ì¶œë˜ì–´ ìˆìŒ.

ğŸ“Œ **ê¸ˆë¦¬ ë° ê±°ì‹œê²½ì œ í™˜ê²½ì˜ ì°¨ë³„ì  ì˜í–¥**
*   ë³´ê³ ì„œì— ì§ì ‘ ì–¸ê¸‰ë˜ì§„ ì•Šì•˜ìœ¼ë‚˜, ê¸ˆë¦¬ëŠ” ê¸ˆìœµì£¼ ì „ë°˜ì„ ê´€í†µí•˜ëŠ” í•µì‹¬ í…Œë§ˆ.
*   **ì€í–‰ì£¼(ìš°ë¦¬ê¸ˆìœµì§€ì£¼, ì¹´ì¹´ì˜¤ë±…í¬)**ëŠ” ê¸ˆë¦¬ ìƒìŠ¹ ì‹œ ìˆœì´ìë§ˆì§„(NIM) ê°œì„  ê¸°ëŒ€ê°ì´ ì¡´ì¬.
*   **ë³´í—˜ì£¼(ì‚¼ì„±ìƒëª…, ì‚¼ì„±í™”ì¬)**ëŠ” ê¸ˆë¦¬ ìƒìŠ¹ì´ ì‹ ê·œ íˆ¬ììì‚°ì˜ ìš´ìš©ìˆ˜ìµë¥ ì„ ë†’ì—¬ ê¸ì •ì ì´ë‚˜, ë™ì‹œì— ë³´ìœ  ì±„ê¶Œ í‰ê°€ì†ì‹¤ì„ ìœ ë°œí•  ìˆ˜ ìˆì–´ ì˜í–¥ì´ ë³µí•©ì . íŠ¹íˆ **ì‚¼ì„±ìƒëª…**ê³¼ ê°™ì€ ìƒëª…ë³´í—˜ì‚¬ëŠ” ìì‚° ë“€ë ˆì´ì…˜ì´ ê¸¸ì–´ ê¸ˆë¦¬ ë³€ë™ì— ë” ë¯¼ê°.

ğŸ“Œ **ë””ì§€í„¸ ì „í™˜(Digital Transformation) ì„±ê³¼**
*   **ì‚¼ì„±í™”ì¬**ëŠ” ë””ì§€í„¸ ì±„ë„ì„ í†µí•œ ì„±ê³µì ì¸ ê³ ê° í™•ë³´ ì‚¬ë¡€ë¥¼ ëª…í™•íˆ ë³´ì—¬ì¤Œ. ì´ëŠ” ì „í†µ ê¸ˆìœµì‚¬ê°€ ì‹ ì„±ì¥ ë™ë ¥ì„ ì–´ë–»ê²Œ ì°½ì¶œí•˜ëŠ”ì§€ ë³´ì—¬ì£¼ëŠ” ëª¨ë²” ì‚¬ë¡€. ë°˜ë©´, ë””ì§€í„¸ ë„¤ì´í‹°ë¸Œì¸ **ì¹´ì¹´ì˜¤ë±…í¬**ëŠ” ì„±ì¥ì„±ê³¼ ë³„ê°œë¡œ ìˆ˜ê¸‰ ì´ìŠˆì— ë°œëª©ì´ ì¡íŒ ìƒí™©ìœ¼ë¡œ, ê¸°ìˆ ë ¥ ì™¸ ì „í†µì  ê¸ˆìœµ ë¶„ì„ ì§€í‘œì˜ ì¤‘ìš”ì„±ë„ ë¶€ê°ë¨.

#### 3. ì¢…ëª©ë³„ ë¦¬ìŠ¤í¬/ì´‰ë°œìš”ì¸ ë° ëª¨ë‹ˆí„°ë§ ì§€í‘œ

**ìš°ë¦¬ê¸ˆìœµì§€ì£¼**
*   âš ï¸ **ë¦¬ìŠ¤í¬**: ë¶€ë™ì‚° ê²½ê¸° ì¹¨ì²´ë¡œ ì¸í•œ ìì‚° ë§¤ê° ì§€ì—° ë˜ëŠ” ë§¤ê°ê°€ í•˜ë½.
*   ğŸ“ˆ **ì´‰ë°œìš”ì¸**: ì„±ê³µì ì¸ ìì‚° ë§¤ê° í›„ í™•ë³´ ìê¸ˆì„ í™œìš©í•œ ë¹„ì€í–‰ M&A ì¶”ì§„ ë°œí‘œ.
*   ğŸ“Œ **ëª¨ë‹ˆí„°ë§ ì§€í‘œ**: ë¶„ê¸°ë³„ ìë³¸ë¹„ìœ¨(CET1) ì¶”ì´, ë¶€ë™ì‚° ë§¤ê° ì§„í–‰ ê²½ê³¼ ë° ìµœì¢… ë§¤ê°ê°€.

**ì‚¼ì„±í™”ì¬**
*   âš ï¸ **ë¦¬ìŠ¤í¬**: ê²½ê¸° ë‘”í™”ì— ë”°ë¥¸ í•´ì™¸ì—¬í–‰ ìˆ˜ìš” ê°ì†Œ, ë””ì§€í„¸ ë³´í—˜ ì‹œì¥ ê²½ìŸ ì‹¬í™”.
*   ğŸ“ˆ **ì´‰ë°œìš”ì¸**: ì—¬í–‰ë³´í—˜ ì™¸ ë‹¤ë¥¸ ë³´ì¢…(ìë™ì°¨, ì¥ê¸° ë“±)ì—ì„œì˜ ë””ì§€í„¸ ì±„ë„ ì„±ê³¼ ê°€ì‹œí™”.
*   ğŸ“Œ **ëª¨ë‹ˆí„°ë§ ì§€í‘œ**: ì›”ë³„ í•´ì™¸ ì¶œêµ­ì ìˆ˜, ì—¬í–‰ë³´í—˜ ì›ìˆ˜ë³´í—˜ë£Œ ì¦ê°ë¥ , ê²½ìŸì‚¬ ë””ì§€í„¸ ìƒí’ˆ ì¶œì‹œ ë™í–¥.

**ì‚¼ì„±ìƒëª…**
*   âš ï¸ **ë¦¬ìŠ¤í¬**: ê¸ˆë¦¬ ê¸‰ë“± ì‹œ ë³´ìœ  ì±„ê¶Œ í‰ê°€ì†ì‹¤ í™•ëŒ€, ëšœë ·í•œ ì„±ì¥ ëª¨ë©˜í…€ ë¶€ì¬.
*   ğŸ“ˆ **ì´‰ë°œìš”ì¸**: ì‹ ê³„ì•½ CSM(ê³„ì•½ì„œë¹„ìŠ¤ë§ˆì§„)ì˜ ì˜ˆìƒ ìƒíšŒ ì„±ì¥, ì‹œì¥ ê¸°ëŒ€ì¹˜ë¥¼ ë›°ì–´ë„˜ëŠ” ì£¼ì£¼í™˜ì› ì •ì±… ë°œí‘œ.
*   ğŸ“Œ **ëª¨ë‹ˆí„°ë§ ì§€í‘œ**: êµ­ê³ ì±„ 10ë…„ë¬¼ ê¸ˆë¦¬ ì¶”ì´, ì™¸êµ­ì¸ ìˆœë§¤ìˆ˜ ë™í–¥, ë¶„ê¸°ë³„ ì‹ ê³„ì•½ CSM ê·œëª¨.

**ì¹´ì¹´ì˜¤ë±…í¬**
*   âš ï¸ **ë¦¬ìŠ¤í¬**: ì”ì—¬ ìŠ¤í†¡ì˜µì…˜ ë¬¼ëŸ‰ì˜ ì¶”ê°€ í–‰ì‚¬ ê°€ëŠ¥ì„±, í”Œë«í¼ ê·œì œ ê°•í™” ìš°ë ¤.
*   ğŸ“ˆ **ì´‰ë°œìš”ì¸**: ëŒ€ì¶œ ì„±ì¥ë¥  íšŒë³µ ë° ì—°ì²´ìœ¨ì˜ ì•ˆì •ì  ê´€ë¦¬, ìˆ˜ê¸‰ ë¶€ë‹´ì„ ìƒì‡„í•  ë§Œí•œ í˜ì‹ ì  ì‹ ê·œ ì„œë¹„ìŠ¤ ì¶œì‹œ.
*   ğŸ“Œ **ëª¨ë‹ˆí„°ë§ ì§€í‘œ**: ìŠ¤í†¡ì˜µì…˜ í–‰ì‚¬ ê°€ëŠ¥ ë¬¼ëŸ‰, ë¶„ê¸°ë³„ ì—¬ì‹  ì„±ì¥ë¥  ë° ì—°ì²´ìœ¨, ì›”ê°„í™œì„±ì´ìš©ììˆ˜(MAU).

**ë©”ë¦¬ì¸ ê¸ˆìœµì§€ì£¼**
*   âš ï¸ **ë¦¬ìŠ¤í¬**: **ì£¼ì£¼í™˜ì› ì •ì±…ì˜ ë¶ˆí™•ì‹¤ì„± ì¦ëŒ€**, ê°ì•¡ë°°ë‹¹ ì¶•ì†Œì— ë”°ë¥¸ íˆ¬ì ë§¤ë ¥ë„ ê°ì†Œ.
*   ğŸ“ˆ **ì´‰ë°œìš”ì¸**: ë¶ˆí™•ì‹¤ì„±ì„ í•´ì†Œí•  ìˆ˜ ìˆëŠ” ìƒˆë¡œìš´ ì¤‘ì¥ê¸° ì£¼ì£¼í™˜ì› ì •ì±…(ìì‚¬ì£¼ ë§¤ì…/ì†Œê° ê°•í™” ë“±) ë°œí‘œ.
*   ğŸ“Œ **ëª¨ë‹ˆí„°ë§ ì§€í‘œ**: ì°¨ê¸° ë°°ë‹¹ ì •ì±… ê´€ë ¨ ê³µì‹œ, ê²½ì˜ì§„ì˜ ì£¼ì£¼í™˜ì› ê´€ë ¨ ì»¤ë®¤ë‹ˆì¼€ì´ì…˜.

#### 4. ê²°ë¡ : í¬íŠ¸í´ë¦¬ì˜¤ ê´€ì  ì œì–¸

ê¸ˆìœµ ì„¹í„° ë‚´ì—ì„œë„ ê°œë³„ ì¢…ëª©ì˜ ëª¨ë©˜í…€ì´ ëšœë ·í•˜ê²Œ ê°ˆë¦¬ê³  ìˆìŠµë‹ˆë‹¤. ê·œì œ, ìˆ˜ê¸‰, ì‹¤ì  ë“± ê°ê¸° ë‹¤ë¥¸ ë™ì¸ì— ì˜í•´ ì£¼ê°€ í–¥ë°©ì´ ê²°ì •ë˜ëŠ” êµ­ë©´ì…ë‹ˆë‹¤.

*   **Overweight (ë¹„ì¤‘í™•ëŒ€): ì‚¼ì„±í™”ì¬, ìš°ë¦¬ê¸ˆìœµì§€ì£¼**
    *   **ì‚¼ì„±í™”ì¬**ëŠ” ë¦¬ì˜¤í”„ë‹ êµ­ë©´ì—ì„œ ê°€ì¥ í™•ì‹¤í•œ ì‹¤ì  ê°œì„  ìŠ¤í† ë¦¬ë¥¼ ë³´ì—¬ì£¼ê³  ìˆìœ¼ë©°, ë””ì§€í„¸ ì „í™˜ ì„±ê³¼ê°€ ê°€ì‹œí™”ë˜ê³  ìˆì–´ ì§€ì†ì ì¸ ê´€ì‹¬ì´ ìœ íš¨í•©ë‹ˆë‹¤.
    *   **ìš°ë¦¬ê¸ˆìœµì§€ì£¼**ëŠ” ìì‚° ë§¤ê°ì„ í†µí•œ í€ë”ë©˜í„¸(ìë³¸ë¹„ìœ¨) ê°œì„ ì´ë¼ëŠ” ëª…í™•í•œ ëª©í‘œë¥¼ ê°€ì§€ê³  ìˆìœ¼ë©°, í˜„ì¬ ì£¼ê°€ ìˆ˜ì¤€ì€ ì´ëŸ¬í•œ ê°œì„  ì—¬ë ¥ì„ ì¶©ë¶„íˆ ë°˜ì˜í•˜ì§€ ëª»í•˜ê³  ìˆë‹¤ê³  íŒë‹¨ë©ë‹ˆë‹¤.

*   **Neutral (ì¤‘ë¦½): ì‚¼ì„±ìƒëª…**
    *   ì—…ì¢… ëŒ€í‘œì£¼ë¡œì„œ ì•ˆì •ì„±ì€ ê°–ì¶”ê³  ìˆìœ¼ë‚˜, í˜„ì¬ ì‹œì ì—ì„œ ì£¼ê°€ ìƒìŠ¹ì„ ì´ëŒ ëšœë ·í•œ ì´‰ë°œìš”ì¸ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. ê¸ˆë¦¬ í™˜ê²½ ë³€í™”ì™€ ìˆ˜ê¸‰ì„ í™•ì¸í•˜ë©° ì ‘ê·¼í•  í•„ìš”ê°€ ìˆìŠµë‹ˆë‹¤.

*   **Underweight (ë¹„ì¤‘ì¶•ì†Œ): ë©”ë¦¬ì¸ ê¸ˆìœµì§€ì£¼, ì¹´ì¹´ì˜¤ë±…í¬**
    *   **ë©”ë¦¬ì¸ ê¸ˆìœµì§€ì£¼**ëŠ” í•µì‹¬ íˆ¬ì ë…¼ë¦¬ì˜€ë˜ ì£¼ì£¼í™˜ì› ì •ì±…ì— ëŒ€í•œ ë¶ˆí™•ì‹¤ì„±ì´ í•´ì†Œë˜ê¸° ì „ê¹Œì§€ ë³´ìˆ˜ì ì¸ ì ‘ê·¼ì´ í•„ìš”í•©ë‹ˆë‹¤. ì •ì±… ë³€í™”ì˜ í­ê³¼ ê·¸ì— ë”°ë¥¸ ì‹œì¥ ë°˜ì‘ì„ ì§€ì¼œë´ì•¼ í•©ë‹ˆë‹¤.
    *   **ì¹´ì¹´ì˜¤ë±…í¬**ëŠ” ë‹¨ê¸°ì ì¸ ìŠ¤í†¡ì˜µì…˜ ì˜¤ë²„í–‰ ì´ìŠˆê°€ ì£¼ê°€ì— ë¶€ë‹´ìœ¼ë¡œ ì‘ìš©í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì„±ì¥ì„±ì— ëŒ€í•œ ê¸°ëŒ€ê°ë§Œìœ¼ë¡œ ë‹¨ê¸° ìˆ˜ê¸‰ ì•…í™”ë¥¼ ê·¹ë³µí•˜ê¸°ëŠ” ì–´ë ¤ìš¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ê²°ë¡ ì ìœ¼ë¡œ, í˜„ì¬ í¬íŠ¸í´ë¦¬ì˜¤ ì „ëµì€ **í€ë”ë©˜í„¸ ê°œì„  ê°€ì‹œì„±ì´ ë†’ì€ ì¢…ëª©(ìš°ë¦¬ê¸ˆìœµ, ì‚¼ì„±í™”ì¬)ì„ ì¤‘ì‹¬ìœ¼ë¡œ ë¹„ì¤‘ì„ í™•ëŒ€**í•˜ê³ , **ì •ì±… ë° ìˆ˜ê¸‰ ê´€ë ¨ ë¶ˆí™•ì‹¤ì„±ì— ë…¸ì¶œëœ ì¢…ëª©(ë©”ë¦¬ì¸ , ì¹´ì¹´ì˜¤ë±…í¬)ì€ ë¹„ì¤‘ì„ ì¤„ì—¬ ë¦¬ìŠ¤í¬ë¥¼ ê´€ë¦¬**í•˜ëŠ” ê²ƒì´ ë°”ëŒì§í•©ë‹ˆë‹¤.
"""


# -----------------------------
# st.secrets â†’ os.environ ì£¼ì…
# -----------------------------
def _prime_env_from_secrets() -> None:
    try:
        if hasattr(st, "secrets") and st.secrets:
            for k, v in st.secrets.items():
                if k == "gcp_service_account":
                    continue
                os.environ.setdefault(k, str(v))
    except Exception:
        pass
_prime_env_from_secrets()

# -----------------------------
# helpers
# -----------------------------
def _parse_stocks(csv_text: str) -> List[str]:
    return [s.strip() for s in csv_text.split(",") if s.strip()]

def _fmt_link(md: Dict[str, Any]) -> str:
    title = md.get("title") or md.get("headline") or md.get("doc_title") or md.get("doc_id") or ""
    url = md.get("url") or md.get("link") or md.get("source_url") or ""
    if url and title: return f"[{title}]({url})"
    if url:           return f"[ì›ë¬¸ ë§í¬]({url})"
    return title or "(ë§í¬/ì œëª© ì—†ìŒ)"

# -----------------------------
# Service ì¸ìŠ¤í„´ìŠ¤ (ìºì‹œ)
# -----------------------------
@st.cache_resource(show_spinner=False)
def get_service() -> Optional[NewsReportService]:
    try:
        return NewsReportService()
    except Exception as e:
        st.warning(f"ì„œë¹„ìŠ¤ ì´ˆê¸°í™” ì‹¤íŒ¨: {e}")
        return None


# ======================
# CSS: ì‚¬ì´ë“œë°” hover ì‹œì—ë§Œ ë³´ì´ë„ë¡
# ======================
st.markdown(
    """
    <style>
    /* ì‚¬ì´ë“œë°” ì „ì²´ë¥¼ ì™¼ìª½ìœ¼ë¡œ ìˆ¨ê¹€ */
    [data-testid="stSidebar"] {
        transform: translateX(-250px);
        transition: all 0.3s;
        opacity: 0.2;  /* ì‚´ì§ë§Œ ë³´ì´ê²Œ */
    }
    /* ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë¦¬ë©´ ì›ìœ„ì¹˜ */
    [data-testid="stSidebar"]:hover {
        transform: translateX(0);
        opacity: 1;
    }
    </style>
    """,
    unsafe_allow_html=True
)

# -----------------------------
# UI
# -----------------------------
st.title("ğŸ“˜ ì—°ê¸ˆìˆ ì‚¬ì˜ ë¹„ë°€ì„œì¬")
st.markdown(
    "<p style='font-size:20px; color:gray;'>âœ¨ ì°½í›ˆë‹˜ì„ ìœ„í•œ ì—°ê¸ˆìˆ ì‚¬ì˜ ì—°ê¸ˆë¦¬í¬íŠ¸ âœ¨</p>",
    unsafe_allow_html=True
)
#st.caption("ìš°ë¦¬ ì—°ê¸ˆìˆ ì‚¬ê°€ ì°½í›ˆë‹˜ì„ ìœ„í•´ ì œì‘í•œ í‡´ì§ì—°ê¸ˆ ì¢…í•© ë¦¬í¬íŠ¸ì—ìš”")

with st.sidebar:
    st.subheader("ì‹¤í–‰ ì„¤ì •")
    stocks_text = st.text_input("ì¢…ëª©(ì½¤ë§ˆë¡œ êµ¬ë¶„)", value="ìš°ë¦¬ê¸ˆìœµì§€ì£¼,ì‚¼ì„±í™”ì¬,ì‚¼ì„±ìƒëª…,ì¹´ì¹´ì˜¤ë±…í¬,ë©”ë¦¬ì¸ ê¸ˆìœµì§€ì£¼", help="ì˜ˆ: ì‚¼ì„±ì „ì,ìš°ë¦¬ê¸ˆìœµì§€ì£¼ / ë˜ëŠ” AAPL,NVDA")
    #template = st.text_input("ì§ˆë¬¸ í…œí”Œë¦¿ (ì˜µì…˜)", value="{stock} ê´€ë ¨í•´ì„œ ì¢…ëª©ì˜ ê°€ê²©ì— ì¤‘ìš”í•œ ë‰´ìŠ¤ëŠ”?")
    #top_k = st.number_input("top_k", min_value=1, max_value=20, value=5, step=1)
    #use_rerank = st.toggle("ë¦¬ë­í¬ ì‚¬ìš© (í˜„ì¬ëŠ” top_k ìë¥´ê¸°)", value=False)
    #rerank_top_k = st.number_input("rerank_top_k", min_value=1, max_value=50, value=5, step=1)
    #max_workers = st.slider("ë™ì‹œ ì²˜ë¦¬ ì“°ë ˆë“œ", min_value=1, max_value=10, value=5)
    run_btn = st.button("ğŸš€ ì‹¤í–‰", type="primary")

st.divider()
# st.markdown("""
# **í•„ìˆ˜ Secrets:** `GOOGLE_CLOUD_PROJECT`, `QDRANT_URL`, `QDRANT_API_KEY`  
# (ì˜µì…˜) `GOOGLE_CLOUD_LOCATION`, `COLLECTION_NAME`, `EMBED_MODEL_NAME`, `GENAI_MODEL_NAME`, `EMBED_DIM`, `DEFAULT_TOP_K`, `RERANK_TOP_K`, `[gcp_service_account]`
# """)

if run_btn:
    stocks = _parse_stocks(stocks_text)
    if not stocks:
        st.error("ì¢…ëª©ì„ 1ê°œ ì´ìƒ ì…ë ¥í•´ ì£¼ì„¸ìš”.")
        st.stop()

    svc = get_service()
    if svc is None:
        st.error("ì„œë¹„ìŠ¤ ì´ˆê¸°í™” ì‹¤íŒ¨. Secrets ì„¤ì •ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.")
        st.stop()

    # ëŸ°íƒ€ì„ ì„¤ì • ë°˜ì˜
    #svc.top_k = int(top_k)
    #svc.use_rerank = bool(use_rerank)
    #svc.rerank_top_k = int(rerank_top_k)

    # (ì„ íƒ) ë””ë²„ê¹…: ê° ì¢…ëª©ì˜ ë³´ìœ  ë¬¸ì„œ ìˆ˜
    cols = st.columns(len(stocks))
    for i, s in enumerate(stocks):
        with cols[i]:
            try:
                c = svc.count_by_stock(s)
                st.caption(f"`{s}` ë¬¸ì„œ ìˆ˜: **{c}**")
            except Exception:
                pass

    with st.spinner("ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•˜ëŠ”ì¤‘..."):
        try:
            #base_template = (template or None)
            result = svc.answer_5_stocks_and_reduce(
                stocks=stocks,
                template=f"{stocks} ê´€ë ¨í•´ì„œ ì¢…ëª©ì˜ ê°€ê²©ì— ì˜í–¥ì„ ë¯¸ì¹˜ëŠ” ì¤‘ìš”í•œ ë‰´ìŠ¤ëŠ”?",
                max_workers=int(5),
            )
        except Exception as e:
            st.exception(e)
            st.stop()
    # ìµœì¢… ë¦¬í¬íŠ¸
    st.subheader("ğŸ“Œ ìµœì¢… ë¦¬í¬íŠ¸")
    final_report = (result.get("final_report") or "").strip()
    if final_report:
        st.markdown(final_report)
    else:
        st.info("ìµœì¢… ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.")

    st.divider()

    # ì¢…ëª©ë³„ ê²°ê³¼
    st.subheader("ğŸ” ì¢…ëª©ë³„ ìš”ì•½ë³´ê¸°")
    for r in result.get("results", []):
        stock = r.get("stock", "")
        with st.expander(f"[{stock}] ìš”ì•½ ë³´ê¸°", expanded=False):
            ans = (r.get("answer") or "").strip()
            if ans:
                st.markdown(ans)
            else:
                st.write("ê´€ë ¨ëœ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")

            # ì†ŒìŠ¤ ë¬¸ì„œ
            src_docs = r.get("source_documents") or []
            if src_docs:
                st.markdown("**ê·¼ê±° ê¸°ì‚¬**")
                for i, d in enumerate(src_docs[:10], start=1):
                    md = d.get("metadata") or {}
                    score = d.get("score")
                    dist_mode = d.get("distance_mode") or ""
                    link = _fmt_link(md)
                    # ë£¨íŠ¸ ìŠ¤í‚¤ë§ˆ: doc_id/stock/chunk_idx/â€¦ ë…¸ì¶œ
                    extra = []
                    if "stock" in md: extra.append(f"stock=`{md.get('stock')}`")
                    if "doc_id" in md: extra.append(f"doc_id=`{md.get('doc_id')}`")
                    if "chunk_idx" in md: extra.append(f"chunk=`{md.get('chunk_idx')}`")
                    meta_line = " â€¢ ".join(extra)
                    #st.markdown(f"- {i}. {link}  \n  - {meta_line} â€¢ score(raw): `{score}` â€¢ mode: `{dist_mode}`")
                    st.markdown(f"- {i}. {link}")
            else:
                st.write("ì†ŒìŠ¤ ë¬¸ì„œ ì—†ìŒ")
#ìµœì¢…ë¦¬í¬íŠ¸ ì˜ˆì‹œ ì¶”ê°€
else:
    st.subheader("ğŸ“Œ ìµœì¢… ë¦¬í¬íŠ¸")
    st.markdown(SAMPLE_FINAL_REPORT)

    st.divider()
    st.subheader("ğŸ” ì¢…ëª©ë³„ ìš”ì•½ë³´ê¸°")




























